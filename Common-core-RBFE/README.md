# Common-core RBFE calculations using the BAT software

Here we introduce the BAT implementation of common-core relative binding free energy (RBFE) calculations, which are more widely used in comparison to RBFE using separated topologies (SepTop), and for this reason we will also refer to them as regular RBFE. Regular RBFE calculations maintain a common substructure between the two ligands during their transformation, and do not require the application of restraints as in ABFE or RBFE with SepTop. The calculations shown here are compatible only with AMBER's *pmemd.cuda* MD engine, and are based on the AMBER tutorial for alchemical free energy calculations using soft-core potentials (https://ambermd.org/tutorials/advanced/tutorial9/index.html). 

We will apply the three-step cycle from the tutorial above, which has two electrostatic and one Lennard-Jones (LJ) free energy calculations for alchemically converting the ligands. The LJ transformation also includes changing the atom types inside the common region and the bonded interactions. The main difference in our method is that these three calculations will use the simultaneous decoupling and recoupling (SDR) approach, in which the ligands undergo opposite transformations in the binding site and bulk solvent, inside the same simulation box. The SDR method is advantageous because it allows for transformations between ligands with different net charges, since the electrostatic calculations will always maintain the same net charge of the simulation periodic cell, avoiding well known artifacts. 



# Required software and input files

In order to perform the calculations shown here, the user must have the same dependencies from the BAT software, with the *pmemd.cuda* software from AMBER being mandatory instead of OpenMM. The input files needed are also the same as the ABFE BAT workflow, which are the coordinates of the ligands and protein in PDB format, the reference.pdb file, and the BAT input file. All variables from the latter file are identical to the ABFE workflow, so the setup of any new protein system can be done in the same way, as well as all the other simulation and analysis options.

It is, although, necessary that BAT recognizes the atoms from the two ligands that are part of their common substructure, and for that reason the two input ligand PDB files must follow a few rules:

- They should already be protonated, and the atoms from a given ligand must all have unique names. 
- All heavy atoms should be listed first in the PDB file, regardless of order, then followed by all the hydrogens.
- Atoms in equivalent positions in the common substructure must have the same names in the two ligand PDB files. Their coordinates do not have to perfectly match, but they are expected to be similar since the binding mode should be preserved to apply regular RBFE.

There are open-source tools that can perform atom-mapping to recognize common substructures between ligands, and they, and likely others, will be added with time to fully automate the process. I am in fact open to suggestions on that matter.

Concerning the BAT common-core RBFE input file, since the input ligands are already protonated and we wish to maintain this state, the user should choose 'yes' for the *retain\_lig\_prot* variable, and define the associated ligand net charge using the *ligand\_charge* variable. This net charge applies to all ligands in the *ligand_list* array, so ligands with different net charges should have their parameter generation and equilibration procedure (*equil* step) performed separately. They can be combined again in the same input file when performing the *rbfe* and *analysis* stages. The ligand parameters can also be provided by the user instead of generated by BAT, as explained in the BAT user guide, as long as the atom naming in the .mol2 files also follows the same rules above. 

We also include the *gti\_add\_sc* variable to the BAT common-core RBFE input file, which allows the user to choose which non-bonded and bonded interactions will be scaled with lambda during the transformations. The different values of this variable will scale the energy contributions according to the table below, obtained from the AMBER user guide:

![](./Table-gti_add_sc.jpg)


More details on this variable, and on the theory and methods behind AMBER's common-core RBFE calculations, can be found in the AMBER user guide.


# Running a sample calculation

We provide example calculations for three pairs of ligands that bind to the BRD4(2) bromodomain and display high similarity within each pair, making them suitable for regular RBFE calculations. We will identify the ligands by the crystal structure PDB code they belong to, the first pair of similar ligands being 5uew-5uey, the second 5u2c-7usj, and the third 4z93-5uoo. Inside the ./Common-core-RBFE/all-poses folder the user will find the receptor and ligand PDB files, the latter already adjusted for common-core RBFE calculations. Also included in the ./Common-core-RBFE folder are the BATcc.py program, which will perform part of the steps needed for a full calculation, and the BAT input file called input-cc-amber.in. This file, and also the reference.pdb file, use the same protein setup as the BAT ABFE tutorial. 

To get started, first erase the ./BAT/all-poses folder and the BAT input files ./BAT/input-sdr-openmm.in and ./BAT/input-dd-amber.in, from the ABFE example located inside the ./BAT folder. Copy the ./Common-core-RBFE/all-poses folder, the ./Common-core-RBFE/input-cc-amber.in file, and the ./Common-core-RBFE/BATcc.py program into the ./BAT folder, which is where the tutorial will be performed. As with the ABFE calculations, there will be three stages: equilibration (*equil* step), free energy calculations setup (named here the *rbfe* step) and analysis of the results after the simulations are finished (*analysis* step). 

## Equilibration

We will perform this example for the 5uew-5uey pair, which is already selected in the input-cc-amber.in file, along with the other needed variables. In the equilibration step BAT will generate the parameters for the two ligands, and setup the equilibration simulations the same way as in the ABFE workflow. Already inside the ./BAT folder, type the following command:

python BAT.py -i input-cc-amber.in -s equil

Note that above we are running the **BAT.py program**, with BATcc.py being used for the next steps. After this command, you will see an ./equil folder, and inside the simulation folders for each of the two ligands. Run the run-local.bash file for each of them in order to run the needed simulations.     

## Free energy calculation

### Simulations

Once the equilibration simulations are **concluded**, it is now time to create all the needed files for the free energy calculations. Again inside the ./BAT folder, now run the following command:

python BATcc.py -i input-cc-amber.in -s rbfe

Note that above we used the **BATcc.py program**, which will also be the case for the *analysis* step. An ./rbfe folder should now have been created, and inside it a folder named after the two ligand molecules from the transformation in question, in this case ./rbfe/lig-5uew\_lig-5uey. Inside this folder there will be two folders for the electrostatic (or charged) calculations, one for each molecule, and one folder for the LJ transformation (or exchange) of the two molecules. 

The free energy windows are inside these three folders identified by a letter followed by a number, with the letter **e** for charged calculations and the letter **x** for the LJ transformation (Ex: e04). Here the windows will be numbered from 0 to 11 since we are using 12 windows for both **e** and **x**, with a total of 36 for the whole calculation. The user should go inside each window folder and run the run-local.bash script, either locally or submit a job running this script to a PBS or SLURM job manager. The SLURMM-run file inside each folder provides an example for the latter case.

 
The charged calculations contain the same ligand in the binding site and in bulk, and will start from the equilibrated state of the respective molecule. The LJ transformation (or exchange) contains both ligands with their common region in the two environments, and will use the equilibrated coordinates of the target molecule. The latter will always be the second ligand listed in the *ligand_list* array from the input-cc-amber.in file, with the reference ligand being the first molecule on this list. Forward and backward calculations can be performed by simply changing the order of the two ligands in the *ligand_list* variable and running the *rbfe* and *analysis* steps again, keeping in mind that this will affect only the LJ exchange calculation. 


### Analysis

After finishing all the simulations from the *rbfe* stage above, we can now run the *analysis* step to obtain the relative binding free energy between the two ligands to BRD4(2). To do that, type the following command inside the ./BAT folder:

python BATcc.py -i input-cc-amber.in -s analysis

A ./Results folder should have been created inside ./rbfe/lig-5uew_lig-5uey, which will contain the results from block data analysis (Res-b*.dat files), and the final relative binding free energy inside the Results.dat file. This file also displays the values for each free energy component, and should look like below:
<pre>
\--------------------------------------------------- 
RBFE from molecules lig-5uew to lig-5uey
\--------------------------------------------------- 
Component            Free Energy; Sigma
Electro 2 (TI);          0.03;    0.16
LJ exchange (TI);        1.28;    0.24
-Electro 1 (TI);        -0.40;    0.10
Total RBFE value;       -0.91;    0.31
\---------------------------------------------------
Energies in kcal/mol
</pre>

The 'Electro 2' component is the decoupling/recoupling of the charged interactions of the unique region of the target molecule in the binding site/bulk, and '-Electro 1' the opposite for the reference molecule. The 'LJ exchange' component is the LJ, atom types and bonded transformations from target to reference ligand in the binding site, and the opposite in bulk.  The 'Total RBFE value' is the sum of these three values multiplied by minus one, which is the free energy difference of going from the reference to the target ligand in the binding site, and the opposite in bulk. 

### Computational cost

A full calculation as the one from this example takes a total of 52.8 nanoseconds, using a 2.0 femtosecond time step without hydrogen mass repartitioning (HMR). The total simulation time per calculation will also depend on the number of lambdas for each transformation and the total number of simulation steps per window, with these parameters defined in the input-cc-amber.in file using the appropriate variables.

The simulation speed on the SDR systems used for these example RBFE calculations is around 70 ns/day when using a single NVIDIA GTX 1070 graphics processing unit (GPU), so a full calculation would take around 18 hours. Newer GPU models, such as the NVIDIA 20 series and above, can do the same by using a fraction of this time. 

In addition, trivial parallelization can be done across all free energy windows, which can significantly reduce the total time needed per calculation. For example, if using 36 GPUs of the GTX 1070 model, the total time for a single calculation would be around forty minutes, and much less than that for newer GPUs. 











   
